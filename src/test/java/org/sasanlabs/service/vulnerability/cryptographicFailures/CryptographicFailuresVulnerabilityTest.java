package org.sasanlabs.service.vulnerability.cryptographicFailures;

import static org.junit.jupiter.api.Assertions.*;

import java.util.HashMap;
import java.util.Map;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.sasanlabs.service.vulnerability.bean.GenericVulnerabilityResponseBean;
import org.springframework.http.ResponseEntity;

public class CryptographicFailuresVulnerabilityTest {
    private CryptographicFailuresVulnerability vuln;

    @BeforeEach
    void setUp() {
        vuln = new CryptographicFailuresVulnerability();
    }

    @Test
    void testLevel1ChallengeAndCorrectPassword() {
        // No password param: should return challenge
        Map<String, String> params = new HashMap<>();
        ResponseEntity<GenericVulnerabilityResponseBean<String>> resp =
                vuln.getVulnerablePayloadLevel1(params);
        assertFalse(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("MD5 hash"));

        // Correct password
        params.put("password", "password123");
        resp = vuln.getVulnerablePayloadLevel1(params);
        assertTrue(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("Correct!"));

        // Incorrect password
        params.put("password", "wrong");
        resp = vuln.getVulnerablePayloadLevel1(params);
        assertFalse(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("Incorrect."));
    }

    @Test
    void testLevel2ChallengeAndCorrectPassword() {
        Map<String, String> params = new HashMap<>();
        ResponseEntity<GenericVulnerabilityResponseBean<String>> resp =
                vuln.getVulnerablePayloadLevel2(params);
        assertFalse(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("SHA1 hash"));

        params.put("password", "admin");
        resp = vuln.getVulnerablePayloadLevel2(params);
        assertTrue(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("Correct!"));

        params.put("password", "wrong");
        resp = vuln.getVulnerablePayloadLevel2(params);
        assertFalse(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("Incorrect."));
    }

    @Test
    void testLevel3ChallengeAndCorrectPassword() {
        Map<String, String> params = new HashMap<>();
        ResponseEntity<GenericVulnerabilityResponseBean<String>> resp =
                vuln.getVulnerablePayloadLevel3(params);
        assertFalse(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("plaintext"));

        params.put("password", "letmein");
        resp = vuln.getVulnerablePayloadLevel3(params);
        assertTrue(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("Correct!"));

        params.put("password", "wrong");
        resp = vuln.getVulnerablePayloadLevel3(params);
        assertFalse(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("Incorrect."));
    }

    @Test
    void testLevel4ChallengeAndCorrectPassword() {
        Map<String, String> params = new HashMap<>();
        ResponseEntity<GenericVulnerabilityResponseBean<String>> resp =
                vuln.getVulnerablePayloadLevel4(params);
        assertFalse(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("Base64 encoding"));

        params.put("password", "s3cretKey");
        resp = vuln.getVulnerablePayloadLevel4(params);
        assertTrue(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("Correct!"));

        params.put("password", "wrong");
        resp = vuln.getVulnerablePayloadLevel4(params);
        assertFalse(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("Incorrect."));
    }

    @Test
    void testLevel5ChallengeAndCorrectPassword() {
        Map<String, String> params = new HashMap<>();
        ResponseEntity<GenericVulnerabilityResponseBean<String>> resp =
                vuln.getSecurePayloadLevel5(params);
        assertTrue(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("SHA-256 + salt"));

        params.put("password", "strongPass!");
        resp = vuln.getSecurePayloadLevel5(params);
        assertTrue(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("Correct!"));

        params.put("password", "wrong");
        resp = vuln.getSecurePayloadLevel5(params);
        assertTrue(resp.getBody().getIsValid()); // Still true, but message is about incorrect
        assertTrue(resp.getBody().getContent().contains("Incorrect."));
    }

    @Test
    void testLevel6Challenge() {
        Map<String, String> params = new HashMap<>();
        ResponseEntity<GenericVulnerabilityResponseBean<String>> resp =
                vuln.getSecurePayloadLevel6(params);
        assertTrue(resp.getBody().getIsValid());
        assertTrue(resp.getBody().getContent().contains("AES-256 encryption"));

        params.put("password", "any");
        resp = vuln.getSecurePayloadLevel6(params);
        assertTrue(resp.getBody().getIsValid());
        assertTrue(
                resp.getBody()
                        .getContent()
                        .contains("AES-256 is a strong symmetric encryption algorithm"));
    }
}
